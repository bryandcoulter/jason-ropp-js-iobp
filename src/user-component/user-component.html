<!-- <link rel="import" href="../../node_modules/@banno/polymer/polymer"> -->
<!-- <link rel="import" href="../../node_modules/@banno/polymer/polymer-element">  -->
<dom-module id="user-component">
  <template>
    <style>
      :host {
        display: block;
      }

      .default-card {
        background-color: #B1A296;
        min-width: 300px;
        width: fit-content;
        padding: 15px;
        margin: 5px;
        border-radius: 5px;
        box-shadow: 3px 3px 2px lightgrey;
      }

      .default-card>input .first-name .last-name {
        width: 20px;
      }

      input {
        margin: 5px;
      }
    </style>
    <template is="dom-if" if="[[userProfileDisplay]]">
      <div class="default-card">
        <p>You have not selected a user</p>
      </div>
    </template>
    <template is="dom-if" if="[[!edit]]">
      <template is="dom-if" if="[[user]]">
        <hgroup class="default-card" on-click="toggleCollapse">
          <h2 class="name">[[user.first]] [[user.last]]</h2>
          <template is="dom-if" if="[[!collapsed]]">
            <h3 class="id">ID: [[user.id]]</h3>
            <h3 class="phone">[[user.phone]]</h3>
            <h3 class="email">
              <a href="dummy@email.com">[[user.email]]</a>
            </h3>
            <h3 class="department">
              [[user.department]]
            </h3>
            <button on-click="toggleView">Edit User</button>
          </template>
        </hgroup>
      </template>
    </template>
    <template is="dom-if" if="[[edit]]">
      <div class="form-box">
        <form autocomplete="on">
          <div id="editUserFields" class="default-card">
            <fieldset>
              <legend>
                Name:
              </legend>
              <input id="fName" type="text" class="first-name" placeholder="First" autocomplete="given-name" value="[[user.first]]" required>
              <input id="lName" type="text" class="last-name" placeholder="Last" autocomplete="family-name" value="[[user.last]]" required>
            </fieldset>
            <fieldset>
              <legend>Contact:</legend>
              <label for="email">
                <input id="email" type="email" placeholder="email"autocomplete="email" value="[[user.email]]" name="email" required>
              </label><br>
              <label for="phone">
                <input id="phone" type="tel" placeholder="phone" autocomplete="tel" value="[[user.phone]]" required>
              </label>
            </fieldset>
            <fieldset>
              <legend>Other:</legend>
              <label for="department">
                <input id="department" placeholder="Department" value="[[user.department]]" required>
              </label>
            </fieldset>

          </div>
          <div class="submit-button-box">
            <button class="form-button" on-click="save" type="submit">Submit</button>
            <button class="form-button" on-click="deleteUser" type="submit">Delete</button>
          </div>
        </form>
      </div>
    </template>
  </template>
  <script>
		'use strict';
		import '@banno/polymer/polymer-element';
		// import '@banno/polymer/polymer';
    class UserComponent extends Polymer.Element {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          edit: {
            type: Boolean,
            value: false
          },
          collapsed: {
            type: Boolean,
            value: false,
            observer: 'collapseDetails'
          },
          user: {
            type: Object,
          },
          users: {
            type: Array,
          },
          userBeforeEdit: {
            type: Object
          },
          userProfile: {
            type: Boolean
          },
          userProfileDisplay: {
            type: Boolean
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        let users = JSON.parse(localStorage.getItem('onboardProjectUsers'));
        if (users === null) {
          this.set('users', []);
        } else {
          this.set('users', users);
        }

        // Only shows if there is not a user selected.
        if (!this.user && this.userProfile) {
          this.userProfileDisplay = true;
        }

      }

      // Makes sure all fields are filled
      checkFields(user) {
        for (let prop in user) {
          if (!user[prop]) {
            window.alert('Please fill out highlighted fields');
            return false;
          }
        }
        return true;
      }

      createNewUserId() {
        let id = [];

        // returns 9 random letters/symbols/numbers and pushes them into the id.
        for (let i = 0; i < 9; i++) { // eslint-disable-line no-magic-numbers
          let number = Math.random() * (94); // eslint-disable-line no-magic-numbers
          id.push(String.fromCharCode(Math.floor(number + 33))); // eslint-disable-line no-magic-numbers
        }
        id = id.join('');

        // Checks to make sure id is not already in use
        if (this.getIdIndex(id)) {
          this.createNewUserId();
        } else {
          return id;
        }
      }

      compileUserFormData() {

        let user = {
          first: this.shadowRoot.querySelector('#fName').value,
          last: this.shadowRoot.querySelector('#lName').value,
          phone: this.shadowRoot.querySelector('#phone').value,
          email: this.shadowRoot.querySelector('#email').value,
          department: this.shadowRoot.querySelector('#department').value
        };

        if (this.user) {
          user.id = this.user.id;
        }

        return user;
      }

      deleteUser() {
        let userIndex = this.getIdIndex(this.user.id);
        this.users.splice(userIndex, 1);
        this.saveToLocalStorage();
      }

      emptyNewUserForm() {
        let fields = this.shadowRoot.querySelectorAll('input');
        for (let field of fields) {
          field.value = '';
        }
      }

      getIdIndex(id) {
        let index = (this.users) ? this.users.findIndex(val => val.id === id) : -1;
        // Returns false if id does not exist
        return (index === -1) ? false : index;
      }

      save(e) {
        e.preventDefault();
        let user = this.compileUserFormData(e);
        if (this.checkFields(user)) {
          // if new user
          if (user.id === undefined) {
            user.id = this.createNewUserId();
            this.users.splice(0, 0, user);

            this.saveToLocalStorage();
            this.emptyNewUserForm();
            // if existing user
          } else {
            let index = this.getIdIndex(this.user.id);
            this.users.splice(index, 1, user);
            this.user = user;

            this.saveToLocalStorage();
            // Updates the information displayed on the user card so when you close the edit window it displays properly
            this.toggleView();
          }

          if (this.collapsed) {
            this.toggleCollapse();
          }
        }
      }

      saveToLocalStorage() {
        localStorage.setItem('onboardProjectUsers', JSON.stringify(this.users));
      }

      toggleCollapse() {
        this.collapsed = this.collapsed !== true;
      }

      toggleView() {
        this.edit = this.edit !== true;
      }
    }

    customElements.define(UserComponent.is, UserComponent);
  </script>
</dom-module>

<!-- User component card has three settings mode="display" mode="edit" mode="create"
  <user-component mode="display"> Displays the user passed into it.

  <user-component mode="edit"> Brings up autofilled input boxes with the current users information
    change and submit the data to update the users information

  <user-component mode="create"> Opens up a form to enter a new users information. This box auto-generates a 9 character id
-->
