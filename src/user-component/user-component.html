<link rel="import" href="polymer.html">
<dom-module id="user-component">
  <template>
    <style>
      :host {
        display: block;
      }

      .default-card {
        background-color: #B1A296;
        min-width: 300px;
        width: fit-content;
        padding: 15px;
        margin: 5px;
        border-radius: 5px;
        box-shadow: 3px 3px 2px lightgrey;
      }

      .default-card>input .first-name .last-name {
        width: 20px;
      }
    </style>
    <template is="dom-if" if="[[create]]">
      <div class="form-box">
        <div class="heading">Add New User:</div>
        <form autocomplete="on" class="default-card">
          <div id="newUserFields" class="new-user-fields">
            <input id="fName" type="text" class="input first-name" autocomplete="given-name" placeholder="First Name" required>
            <input id="lName" type="text" class="input last-name" autocomplete="family-name" placeholder="Last Name" required>
            <input id="email" type="email" class="input" autocomplete="email" placeholder="Email" name="email" required>
            <input id="phone" type="tel" class="input" autocomplete="tel" placeholder="Phone" required>
            <input id="department" class="input" placeholder="department" required>
          </div>
          <div class="submit-button-box">
            <button class="form-button" on-click="saveNewUser" type="submit">Submit</button>
          </div>
        </form>
      </div>
    </template>
    <template is="dom-if" if="[[display]]">
      <hgroup class="default-card" on-click="toggleCollapse">
        <h2 class="name">[[user.first]] [[user.last]]</h2>
        <template is="dom-if" if="[[!collapsed]]">
          <h3 class="id">ID: [[user.id]]</h3>
          <h3 class="phone">[[user.phone]]</h3>
          <h3 class="email">
            <a href="dummy@email.com">[[user.email]]</a>
          </h3>
          <h3 class="department">
            [[user.department]]
          </h3>
          <button on-click="editUserDisplay">Edit User</button>
        </template>
        <template is="dom-if" if="[[admin]]">
          <button on-click="[[editUserDisplay]]">Edit User Details</button>
        </template>
      </hgroup>
    </template>
    <template is="dom-if" if="[[edit]]">
      <div class="form-box">
        <form autocomplete="on">
          <div id="editUserFields" class="default-card">
            <h5>Name:</h5>
            <input id="editFName" type="text" class="input first-name" autocomplete="given-name" value="[[user.first]]" required>
            <input id="editLName" type="text" class="input last-name" autocomplete="family-name" value="[[user.last]]" required>
            <h5>Id:</h5>
            <p id="editId" value="[[user.id]]">[[user.id]]</p>
            <h5>Email:</h5>
            <input id="editEmail" type="email" class="input" autocomplete="email" value="[[user.email]]" name="email" required>
            <h5>Phone:</h5>
            <input id="editPhone" type="tel" class="input" autocomplete="tel" value="[[user.phone]]" required>
            <h5>Department:</h5>
            <input id="editDepartment" class="input" value="[[user.department]]" required>
          </div>
          <div class="submit-button-box">
            <button class="form-button" on-click="saveUserEdit" type="submit">Submit</button>
            <button class="form-button" on-click="deleteUser" type="submit">Delete</button>
          </div>
        </form>
      </div>
    </template>
  </template>
  <script>
    'use strict';
    class UserComponent extends Polymer.Element {
      static get is() { return 'user-component'; }
      static get properties() {
        return {
          edit: {
            type: Boolean,
            value: false
          },
          create: {
            type: Boolean,
            value: false
          },
          display: {
            type: Boolean,
            value: false
          },
          collapsed: {
            type: Boolean,
            value: false,
            observer: 'collapseDetails'
          },
          user: {
            type: Object,
            observer: 'confirm'
          },
          userBeforeEdit: {
            type: Object
          },
          mode: {
            type: String,
            observer: 'changeMode'
          }
        };
      }
      ready() {
        super.ready();

        // Temporary setting user for checking user profile
        if (!this.user) {
          this.user = this.getUsers()[0];
        }
      }

      changeMode() {
        switch (this.mode) {
          case 'edit':
            this.editUserDisplay();
            break;
          case 'create':
            this.createUserDisplay();
            break;
          case 'display':
            this.showUserDisplay();
            break;
          default:
            break;
        }
      }

      // Makes sure all fields are filled
      checkFields(user) {
        for (let prop in user) {
          if (!user[prop]) {
            window.alert('Please fill out highlighted fields');
            return false;
          }
        }
        return true;
      }

      createNewUserId() {
        let id = [];

        // returns 9 random letters/symbols/numbers and pushes them into the id.
        for (let i = 0; i < 9; i++) { // eslint-disable-line no-magic-numbers
          let number = Math.random() * (94); // eslint-disable-line no-magic-numbers
          id.push(String.fromCharCode(Math.floor(number + 33))); // eslint-disable-line no-magic-numbers
        }
        id = id.join('');

        // Checks to make sure id is not already in use
        if (this.getIdIndex(id)) {
          this.createNewUserId();
        } else {
          return id;
        }
      }

      compileUserFormData() {
        let user = {
          first: this.shadowRoot.querySelector('#fName').value,
          last: this.shadowRoot.querySelector('#lName').value,
          phone: this.shadowRoot.querySelector('#phone').value,
          email: this.shadowRoot.querySelector('#email').value,
          department: this.shadowRoot.querySelector('#department').value
        };
        this.checkFields(user);

        return user;
      }
      compileEditUserFormData() {
        let user = {
          first: this.shadowRoot.querySelector('#editFName').value,
          last: this.shadowRoot.querySelector('#editLName').value,
          phone: this.shadowRoot.querySelector('#editPhone').value,
          email: this.shadowRoot.querySelector('#editEmail').value,
          id: this.shadowRoot.querySelector('#editId').value,
          department: this.shadowRoot.querySelector('#editDepartment').value
        };
        this.checkFields(user);

        return user;
      }

      deleteUser() {
        let user = this.compileEditUserFormData();
        let users = this.getUsers();

        users.splice(this.getIdIndex(user.id), 1);
        this.saveToLocalStorage(users);
        this.showUserDisplay();
      }

      emptyNewUserForm() {
        let fields = this.shadowRoot.querySelector('#newUserFields').children;

        for (let field of fields) {
          field.value = '';
        }
      }

      getIdIndex(id) {
        let users = this.getUsers();

        let index = (users) ? users.findIndex(val => val.id === id) : -1;

        // Returns false if id does not exist
        return (index === -1) ? false : index;
      }

      getUsers() {
        let users = JSON.parse(localStorage.getItem('onboardProjectUsers'));

        // checks to see if array has users, if not, inits a users aray
        if (!users[0]) {
          users = [];
        }
        return users;
      }

      saveNewUser(e) {
        e.preventDefault();
        let user = this.compileUserFormData();

        if (this.checkFields(user)) {
          // Gives the new user a unique autogenerated id
          user.id = this.createNewUserId();

          let users = this.getUsers();

          if (users[0]) {
            users.push(user);
          } else {
            users = [user];
          }

          this.emptyNewUserForm();

          this.saveToLocalStorage(users);
        }
      }

      saveUserEdit(e) {
        e.preventDefault();
        let user = this.compileEditUserFormData();
        let fieldsFilled = this.checkFields(user);

        if (fieldsFilled) {

          let user = this.compileEditUserFormData();
          let users = this.getUsers();
          let index = this.getIdIndex(user.id);

          users.splice(index, 1, user);

          // Updates the information displayed on the user card
          this.user = user;

          this.saveToLocalStorage(users);
          this.showUserDisplay();

          if (this.collapsed) {
            this.toggleCollapse();
          }

        }
      }

      saveToLocalStorage(users) {
        localStorage.setItem('onboardProjectUsers', JSON.stringify(users));
      }

      toggleCollapse() {
        this.collapsed = this.collapsed !== true;
      }

      editUserDisplay() {
        this.userBeforeEdit = this.user;
        this.edit = true;
        this.display = false;
        this.create = false;
      }

      createUserDisplay() {
        this.edit = false;
        this.display = false;
        this.create = true;
      }

      showUserDisplay() {
        this.edit = false;
        this.display = true;
        this.create = false;
      }
    }

    customElements.define(UserComponent.is, UserComponent);
  </script>
</dom-module>

<!-- User component card has three settings mode="display" mode="edit" mode="create"
  <user-component mode="display"> Displays the user passed into it.

  <user-component mode="edit"> Brings up autofilled input boxes with the current users information
    change and submit the data to update the users information

  <user-component mode="create"> Opens up a form to enter a new users information. This box auto-generates a 9 character id
-->
